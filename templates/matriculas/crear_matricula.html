{% extends "base.html" %}

{% block content %}
<h2>Crear matrícula</h2>
<h3>Cargar Información del Estudiante</h3>

<form method="GET" id="cargar-estudiante-form">
    {% csrf_token %}
    <label for="codigo_estudiante">Código del Estudiante:</label>
    <input type="text" id="codigo_estudiante" name="codigo_estudiante" required>
    <button type="submit">Buscar</button>
</form>

<!-- Información del Estudiante -->
<div id="info-estudiante" style="display:none;">
    <h3>Información del Estudiante</h3>
    <p id="nombre-estudiante"></p> <!-- Nombre del estudiante -->
    <p id="apellido-estudiante"></p>
    <div id="semestres">
        <h4>Seleccionar Semestre</h4>
        <select id="semestre-select">
            <option value="">Selecciona un semestre</option>
            {% for semestre in semestres %}
                <option value="{{ semestre.id }}">{{ semestre.año }} - {{ semestre.periodo }}</option>
            {% endfor %}
        </select>
        <button id="cargar-secciones">Cargar Secciones</button>
    </div>
    
    <div id="secciones-disponibles" style="display:none;">
        <h4>Secciones Disponibles</h4>
        <div id="secciones-lista"></div> <!-- Aquí se mostrarán las secciones -->
    </div>
</div>
<div id="secciones-seleccionadas">
    <h4>Secciones Añadidas</h4>
    <!-- Aquí se mostrarán las secciones seleccionadas -->
</div>
<script>
    document.getElementById('cargar-estudiante-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Evita el envío del formulario

        const codigoEstudiante = document.getElementById('codigo_estudiante').value;

        fetch("{% url 'crear_matricula' %}?codigo_estudiante=" + codigoEstudiante)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    // Mostrar nombre del estudiante
                    document.getElementById('info-estudiante').style.display = 'block';
                    document.getElementById('nombre-estudiante').innerText = data.nombre_estudiante;
                    document.getElementById('apellido-estudiante').innerText = data.apellido_estudiante; 
                    // Mostrar semestres disponibles
                    document.getElementById('semestres').style.display = 'block';
                }
            })
            .catch(error => console.error('Error al cargar el estudiante:', error));
    });

    document.getElementById('cargar-secciones').addEventListener('click', function() {
        const semestreId = document.getElementById('semestre-select').value;
        if (!semestreId) {
            alert('Por favor, seleccione un semestre.');
            return;
        }

        fetch(`/matriculas/cargar_secciones/${semestreId}/`)
    .then(response => response.json())
    .then(data => {
        const seccionesLista = document.getElementById('secciones-lista');
        seccionesLista.innerHTML = ''; // Limpiar lista anterior

        data.forEach(seccion => {
            const div = document.createElement('div');
            div.innerHTML = `${seccion['curso__nombre']} - ${seccion['nombre']} - <button onclick="añadirSeccion(${seccion.id})">Añadir</button>`;
            seccionesLista.appendChild(div);
        });
        document.getElementById('secciones-disponibles').style.display = 'block';
    })
    .catch(error => console.error('Error al cargar secciones:', error));

    });


function añadirSeccion(seccionId) {
    const codigoEstudiante = document.getElementById('codigo_estudiante').value;

    // Hacer la petición para validar la sección
    fetch(`/matriculas/validar_seccion/${codigoEstudiante}/${seccionId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);  // Mostrar error si no cumple con los requisitos
            } else {
                // Comprobar si el curso ya fue añadido
                const seccionLista = document.getElementById('secciones-seleccionadas');
                const seccionesExistentes = Array.from(seccionLista.getElementsByTagName('p'));

                const cursoYaAñadido = seccionesExistentes.some(element => 
                    element.innerText.includes(data.curso_nombre)
                );

                if (cursoYaAñadido) {
                    alert(`Ya has añadido una sección del curso ${data.curso_nombre}. No puedes inscribir en múltiples secciones del mismo curso.`);
                } else {
                    alert(`Sección añadida exitosamente.`);

                    // Crear un nuevo elemento para la sección añadida
                    const nuevoElemento = document.createElement('div');
                    nuevoElemento.innerHTML = `
                        <p>Curso: ${data.curso_nombre} - Sección: ${data.seccion_nombre} 
                        <button onclick="removerSeccion(${seccionId})">Remover</button></p>`;
                    
                    // Añadir el nuevo elemento a la lista de secciones seleccionadas
                    seccionLista.appendChild(nuevoElemento);
                }
            }
        })
        .catch(error => console.error('Error al validar la sección:', error));
}

</script>
{% endblock %}
